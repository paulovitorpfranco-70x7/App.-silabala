<div class="space-y-6">
  <header class="flex justify-between items-center flex-wrap gap-4">
    <div>
      <h2 class="text-3xl font-bold text-[var(--text-color)]">Produtos Prontos para Venda üíï</h2>
      <p class="text-[var(--secondary-color)] mt-1">Gerencie seus produtos e veja seus lucros em tempo real.</p>
    </div>
    <div class="flex items-center gap-4">
        <button (click)="exportCatalog()" title="Exportar Cat√°logo em PDF"
                class="bg-[#C8B7E8] hover:bg-purple-400 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 flex items-center">
            <span class="mr-2">üìÑ</span> Exportar Cat√°logo
        </button>
        <button (click)="openNewProductModal()"
                class="text-white font-bold py-2 px-4 rounded-xl shadow-md transition duration-300 flex items-center bg-[var(--accent-color)] hover:opacity-80">
            <span class="mr-2 text-xl">‚ú®</span> Novo Produto
        </button>
    </div>
  </header>

  <!-- Filters -->
  <div class="p-4 rounded-2xl flex items-center gap-4 bg-[var(--card-color)] border border-[var(--input-border-color)] shadow-sm">
      <div class="relative flex-grow" title="Digite para buscar um produto üíï">
          <span class="absolute inset-y-0 left-0 flex items-center pl-3">
              <svg class="w-5 h-5 text-purple-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
              </svg>
          </span>
          <input type="text" [ngModel]="searchTerm()" (ngModelChange)="searchTerm.set($event)"
                 placeholder="Buscar produto pelo nome..."
                 class="w-full sm:text-sm">
      </div>
      <select [ngModel]="filterStatus()" (ngModelChange)="filterStatus.set($event)"
              class="sm:text-sm">
          <option value="all">Todos</option>
          <option value="Dispon√≠vel">Dispon√≠veis</option>
          <option value="Esgotado">Esgotados</option>
          <option value="Em produ√ß√£o">Em produ√ß√£o</option>
      </select>
  </div>

  <div class="rounded-2xl shadow-md overflow-x-auto bg-[var(--card-color)] border border-[var(--input-border-color)]">
    <table class="min-w-full divide-y divide-[var(--input-border-color)]">
      <thead class="bg-[var(--card-bg-hover)]">
        <tr>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-[var(--secondary-color)] uppercase tracking-wider">Produto</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-[var(--secondary-color)] uppercase tracking-wider">Pre√ßo Venda</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-[var(--secondary-color)] uppercase tracking-wider">Custo Total</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-[var(--secondary-color)] uppercase tracking-wider">Lucro</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-[var(--secondary-color)] uppercase tracking-wider">Estoque</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-[var(--secondary-color)] uppercase tracking-wider">Status</th>
          <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-[var(--secondary-color)] uppercase tracking-wider">A√ß√µes</th>
        </tr>
      </thead>
      <tbody class="bg-[var(--card-color)] divide-y divide-[var(--input-border-color)]">
        @for (product of filteredProducts(); track product.id) {
          <tr class="hover:bg-[var(--card-bg-hover)] transition-colors">
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center gap-4">
                    <img [src]="product.imageUrl || 'https://via.placeholder.com/100'" alt="{{ product.name }}" class="w-12 h-12 rounded-lg object-cover">
                    <span class="font-medium text-[var(--text-color)]">{{ product.name }}</span>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-pink-600 dark:text-pink-300">{{ product.price | currency:'BRL' }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-[var(--secondary-color)]">{{ product.totalCost | currency:'BRL' }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-600 dark:text-green-400">
                {{ product.profit | currency:'BRL' }} 
                <span class="text-xs text-green-500 dark:text-green-500">({{ (product.profit / product.totalCost * 100) | number:'1.0-0' }}%)</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold" [class]="product.stock < 5 ? 'text-red-600' : 'text-[var(--text-color)]'">
              {{ product.stock }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full" [class]="getStatusClass(product.status)">
                    {{ product.status }}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-right">
                <button (click)="openEditProductModal(product)" title="Editar produto" class="p-2 rounded-full hover:bg-purple-100 text-purple-500 transition-colors">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                </button>
                <button (click)="deleteProduct(product.id)" title="Excluir produto" class="p-2 rounded-full hover:bg-pink-100 text-pink-500 transition-colors">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                </button>
            </td>
          </tr>
        } @empty {
          <tr>
            <td colspan="7" class="text-center py-16 text-[var(--secondary-color)]">
              <div class="text-5xl">üéÄ</div>
              <p class="mt-4 font-semibold">Nenhum produto cadastrado ainda.</p>
              <p class="text-sm">Clique em "+ Novo Produto" para come√ßar!</p>
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>
</div>

<!-- Add/Edit Product Modal -->
@if (showModal() && currentProduct(); as form) {
  <div class="fixed inset-0 bg-black bg-opacity-50 z-40 flex justify-center items-center p-4" (click)="closeModal()">
    <div class="bg-[var(--bg-color)] rounded-2xl shadow-xl p-6 w-full max-w-4xl max-h-[95vh] flex flex-col modal-content" (click)="$event.stopPropagation()">
      <h2 class="text-2xl font-bold mb-6 text-[var(--text-color)]">{{ isEditing() ? 'Editar Produto' : 'Cadastrar Produto üíù' }}</h2>
      
      <div class="overflow-y-auto pr-4 flex-grow grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Left Column: Details & Image -->
        <div class="space-y-4">
            <div class="flex flex-col items-center space-y-2">
                @if (form.imageUrl) {
                    <img [src]="form.imageUrl" alt="Preview" class="w-32 h-32 rounded-2xl object-cover border-4 border-pink-200 shadow-lg">
                } @else {
                    <div class="w-32 h-32 rounded-2xl bg-pink-100 flex items-center justify-center border-2 border-dashed border-pink-300">
                        <span class="text-5xl text-pink-400">üñºÔ∏è</span>
                    </div>
                }
                <label class="cursor-pointer bg-[var(--card-color)] border border-pink-300 text-pink-600 font-semibold px-4 py-2 rounded-lg text-sm hover:bg-pink-50 transition-colors shadow-sm">
                    <span>Selecionar Imagem</span>
                    <input type="file" (change)="onFileSelected($event)" accept="image/*" class="hidden">
                </label>
            </div>
            <div>
                <label class="block text-sm font-medium text-[var(--secondary-color)]">Nome do Produto *</label>
                <input type="text" [ngModel]="form.name" (ngModelChange)="updateCurrentProductField('name', $event)"
                       class="mt-1 block w-full">
            </div>
            <div>
                <label class="block text-sm font-medium text-[var(--secondary-color)]">Descri√ß√£o Curta</label>
                <textarea rows="3" [ngModel]="form.description" (ngModelChange)="updateCurrentProductField('description', $event)"
                          class="mt-1 block w-full"></textarea>
            </div>
            <div>
                <label class="block text-sm font-medium text-[var(--secondary-color)]">Tempo de Produ√ß√£o (minutos)</label>
                <input type="number" [ngModel]="form.timeMinutes" (ngModelChange)="updateCurrentProductField('timeMinutes', $event)"
                       class="mt-1 block w-full">
            </div>
        </div>

        <!-- Right Column: Materials & Pricing -->
        <div class="space-y-4">
            <div>
                <h3 class="text-lg font-semibold text-[var(--text-color)]">Materiais Utilizados</h3>
                <div class="mt-2 space-y-2 max-h-48 overflow-y-auto pr-2 border rounded-lg p-2 bg-[var(--card-bg-hover)]">
                    @for(material of dataService.materials(); track material.id) {
                       <div class="flex items-center justify-between p-2 rounded-lg hover:bg-[var(--highlight-bg)]">
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <div class="relative flex items-center justify-center w-4 h-4 shrink-0">
                                    <input type="checkbox" [checked]="form.materials.has(material.id)" (change)="onMaterialSelect(material.id, $event)"
                                           class="peer appearance-none h-4 w-4 rounded border-2 border-pink-300 focus:ring-pink-500 focus:ring-offset-0 checked:bg-pink-500 checked:border-0 bg-[var(--input-bg)]">
                                    <svg class="absolute w-3 h-3 text-white hidden peer-checked:block pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="20 6 9 17 4 12"></polyline>
                                    </svg>
                                </div>
                                <p class="font-medium text-sm text-[var(--text-color)]">{{ material.name }}</p>
                            </label>
                            @if (form.materials.has(material.id)) {
                                <input type="number" [value]="form.materials.get(material.id)" (input)="updateMaterialQuantity(material.id, $event)" 
                                       class="w-20 text-right text-sm p-1 rounded-md bg-[var(--card-bg-hover)] border border-pink-200 text-[var(--text-color)] focus:ring-1 focus:ring-pink-400">
                            }
                       </div>
                    } @empty {
                      <p class="text-center text-sm text-[var(--secondary-color)] py-4">Nenhum material cadastrado.</p>
                    }
                </div>
            </div>

            <!-- Pricing Details -->
            <div class="bg-[var(--card-color)] border border-[var(--input-border-color)] p-4 rounded-2xl space-y-3">
                <div class="flex justify-between items-center">
                    <label class="block text-sm font-medium text-[var(--secondary-color)]">Pre√ßo de Venda (R$)</label>
                    <input type="number" [ngModel]="form.price" (ngModelChange)="updateCurrentProductField('price', $event)"
                           class="w-32 text-right font-bold">
                </div>
                <div class="text-sm text-[var(--secondary-color)] flex justify-between">
                    <span>Custo Total Calculado:</span>
                    <span class="font-semibold">{{ formCalculations().totalCost | currency:'BRL' }}</span>
                </div>
                <div class="text-sm text-green-700 flex justify-between">
                    <span class="font-bold">Lucro Estimado:</span>
                    <span class="font-bold">{{ formCalculations().profit | currency:'BRL' }} ({{ formCalculations().margin | number:'1.0-0' }}%)</span>
                </div>
            </div>

            <!-- Stock & Status -->
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-[var(--secondary-color)]">Qtd. em Estoque</label>
                    <input type="number" [ngModel]="form.stock" (ngModelChange)="updateCurrentProductField('stock', $event)"
                           class="mt-1 block w-full">
                </div>
                <div>
                    <label class="block text-sm font-medium text-[var(--secondary-color)]">Status</label>
                    <select [ngModel]="form.status" (ngModelChange)="updateCurrentProductField('status', $event)"
                            class="mt-1 block w-full">
                        <option value="Dispon√≠vel">Dispon√≠vel</option>
                        <option value="Esgotado">Esgotado</option>
                        <option value="Em produ√ß√£o">Em produ√ß√£o</option>
                    </select>
                </div>
            </div>
        </div>
      </div>
      
      <!-- Actions -->
      <div class="flex justify-end gap-4 pt-6 border-t border-[var(--input-border-color)] mt-6">
        <button (click)="closeModal()" class="font-bold py-2 px-6 rounded-xl transition bg-[var(--card-color)] text-[var(--secondary-color)] border border-[var(--input-border-color)] hover:bg-[var(--card-bg-hover)]">
          Cancelar
        </button>
        <button (click)="saveProduct()" class="text-white font-bold py-2 px-6 rounded-xl shadow-md transition bg-[var(--accent-color)] hover:opacity-80">
          Salvar Produto üíï
        </button>
      </div>
    </div>
  </div>
}