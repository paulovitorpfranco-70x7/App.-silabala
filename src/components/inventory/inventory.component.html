<div class="space-y-6">
  <header class="flex justify-between items-center flex-wrap gap-4">
    <div>
      <h2 class="text-3xl font-bold text-[var(--text-color)]">Estoque de Materiais</h2>
      <p class="text-[var(--secondary-color)] mt-1">Gerencie os materiais para suas criaÃ§Ãµes.</p>
    </div>
    <button (click)="triggerFileInput()" title="Importar vÃ¡rios materiais de uma planilha ğŸ’•"
            class="bg-purple-300 dark:bg-purple-600 hover:bg-purple-400 dark:hover:bg-purple-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 flex items-center">
      <span class="mr-2 text-xl">ğŸ“‚</span> Importar Planilha (.xlsx)
    </button>
    <input type="file" #fileInput (change)="handleFileUpload($event)" accept=".xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" class="hidden">
  </header>

  <!-- Messages Area -->
  @if (pageMessage(); as msg) {
    <div role="alert"
         [class]="'p-4 rounded-lg border-l-4 ' + 
            (msg.type === 'success' ? 'bg-[var(--success-bg)] border-green-500 text-[var(--success-text)]' : 
            (msg.type === 'error' ? 'bg-[var(--danger-bg)] border-red-500 text-[var(--danger-text)]' :
            'bg-[var(--info-bg)] border-blue-500 text-[var(--info-text)]'))">
        <p class="font-bold">{{ msg.text }}</p>
        @if (msg.details && msg.details.length > 0) {
          <ul class="mt-2 list-disc list-inside text-sm">
            @for(detail of msg.details; track detail) {
              <li>{{ detail }}</li>
            }
          </ul>
        }
    </div>
  }
  @if (lastDeletedMaterial(); as deleted) {
    <div class="bg-[var(--warning-bg)] border-l-4 border-yellow-500 text-[var(--warning-text)] p-3 rounded-lg flex justify-between items-center text-sm">
      <p>"{{ deleted.material.name }}" foi excluÃ­do.</p>
      <button (click)="undoDelete()" class="font-bold hover:underline px-3 py-1">Desfazer</button>
    </div>
  }

  <div class="rounded-2xl shadow-md overflow-x-auto bg-[var(--card-color)] border border-[var(--input-border-color)]">
    <table class="min-w-full divide-y divide-[var(--input-border-color)]">
      <thead class="bg-[var(--card-bg-hover)]">
        <tr>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-[var(--secondary-color)] uppercase tracking-wider"></th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-[var(--secondary-color)] uppercase tracking-wider">Material</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-[var(--secondary-color)] uppercase tracking-wider">Estoque Atual</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-[var(--secondary-color)] uppercase tracking-wider">Unidade</th>
          <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-[var(--secondary-color)] uppercase tracking-wider">AÃ§Ãµes</th>
        </tr>
      </thead>
      <tbody class="bg-[var(--card-color)] divide-y divide-[var(--input-border-color)]">
        @for (material of materials(); track material.id) {
          <tr [class]="material.stock < 10 ? 'bg-red-500/10 hover:bg-red-500/20' : 'hover:bg-[var(--card-bg-hover)]'">
            <td class="px-6 py-4 whitespace-nowrap">
                <img [src]="material.imageUrl || 'https://via.placeholder.com/100'" alt="{{ material.name }}" class="w-10 h-10 rounded-full object-cover">
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-[var(--text-color)]">{{ material.name }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold" [class]="material.stock < 10 ? 'text-red-600' : 'text-[var(--text-color)]'">
              {{ material.stock }}
              @if (material.stock < 10) {
                <span class="text-red-500 ml-2 text-xs">(Baixo!)</span>
              }
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-[var(--secondary-color)]">{{ material.unit }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-right">
                <button (click)="openEditModal(material)" title="Editar material" class="p-2 rounded-full hover:bg-purple-100 text-purple-400 transition-colors">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                </button>
                <button (click)="openDeleteConfirm(material)" title="Excluir material" class="p-2 rounded-full hover:bg-pink-100 text-pink-500 transition-colors">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                </button>
            </td>
          </tr>
        } @empty {
          <tr>
            <td colspan="5" class="text-center py-10 text-[var(--secondary-color)]">
              <div class="text-4xl">ğŸ€</div>
              <p class="mt-2">Nenhum material cadastrado no estoque.</p>
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>
</div>

<!-- Edit Material Modal -->
@if (editingMaterial(); as material) {
  <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4" (click)="closeEditModal()">
    <div class="bg-[var(--bg-color)] rounded-2xl shadow-2xl p-6 w-full max-w-md" (click)="$event.stopPropagation()">
      <h3 class="text-xl font-bold text-[var(--text-color)] mb-4">Editar Material</h3>
      <form (ngSubmit)="saveEditedMaterial()" class="space-y-4">
          <input type="text" [(ngModel)]="editedMaterialName" name="editedName" placeholder="Nome do material" class="w-full">
          <input type="number" [(ngModel)]="editedMaterialStock" name="editedStock" placeholder="Quantidade em estoque" class="w-full">
          <select [(ngModel)]="editedMaterialUnit" name="editedUnit" class="w-full">
            <option value="un">Unidade (un)</option>
            <option value="m">Metro (m)</option>
            <option value="cm">CentÃ­metro (cm)</option>
            <option value="g">Grama (g)</option>
            <option value="ml">Mililitro (ml)</option>
            <option value="pct">Pacote (pct)</option>
            <option value="m2">Metro quadrado (mÂ²)</option>
            <option value="cm2">CentÃ­metro quadrado (cmÂ²)</option>
          </select>
          <div class="flex justify-end gap-4 pt-4">
              <button type="button" (click)="closeEditModal()" class="font-bold py-2 px-6 rounded-xl bg-[var(--card-color)] text-[var(--secondary-color)] border border-[var(--input-border-color)] hover:bg-[var(--card-bg-hover)]">
                  Cancelar
              </button>
              <button type="submit" class="text-white font-bold py-2 px-6 rounded-xl shadow-md bg-[var(--accent-color)] hover:opacity-80">
                  Salvar
              </button>
          </div>
      </form>
    </div>
  </div>
}

<!-- Delete Confirmation Modal -->
@if (materialToDelete(); as material) {
  <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4" (click)="closeDeleteConfirm()">
    <div class="bg-[var(--bg-color)] rounded-2xl shadow-2xl p-8 w-full max-w-md text-center" (click)="$event.stopPropagation()">
      <div class="text-5xl mb-4">ğŸ—‘ï¸</div>
      <h3 class="text-xl font-bold text-[var(--text-color)] mb-2">Excluir Material?</h3>
      <p class="text-[var(--secondary-color)] mb-6">Excluir <strong class="text-pink-600">"{{ material.name }}"</strong>? <br/> Esta aÃ§Ã£o nÃ£o pode ser desfeita.</p>
      <div class="flex justify-center gap-4">
          <button (click)="closeDeleteConfirm()" class="font-bold py-2 px-8 rounded-xl bg-[var(--card-color)] text-[var(--secondary-color)] border border-[var(--input-border-color)] hover:bg-[var(--card-bg-hover)]">
              Cancelar
          </button>
          <button (click)="confirmDelete()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-8 rounded-lg shadow-md">
              Excluir
          </button>
      </div>
    </div>
  </div>
}